<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dƒ∞L-BOZ v9 | Ses Zinciri</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;700;900&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0D0D14;
            --surface: #16161F;
            --card: #1E1E2E;
            --border: #2A2A40;
            --primary: #7C3AED;
            --primary-glow: rgba(124,58,237,0.35);
            --accent: #F59E0B;
            --danger: #EF4444;
            --success: #10B981;
            --text: #F1F0FF;
            --muted: #6B7280;
            --wave: #7C3AED;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--bg);
            font-family: 'DM Sans', sans-serif;
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        /* Arka plan efekti */
        .bg-orbs {
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
            overflow: hidden;
        }
        .orb {
            position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.18;
            animation: orbFloat 8s ease-in-out infinite alternate;
        }
        .orb1 { width: 500px; height: 500px; background: #7C3AED; top: -100px; left: -100px; }
        .orb2 { width: 400px; height: 400px; background: #EF4444; bottom: -100px; right: -50px; animation-delay: -4s; }
        .orb3 { width: 300px; height: 300px; background: #F59E0B; top: 40%; left: 40%; animation-delay: -2s; }
        @keyframes orbFloat { from { transform: translate(0,0) scale(1); } to { transform: translate(30px, 40px) scale(1.1); } }

        .panel {
            position: relative; z-index: 1;
            width: 95%; max-width: 820px;
            height: 88vh;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 32px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 40px 80px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.05) inset;
        }

        .header {
            padding: 18px 28px;
            background: linear-gradient(135deg, var(--primary), #9333EA);
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0;
        }

        .header-title {
            font-family: 'Unbounded', sans-serif;
            font-size: 1.4rem; font-weight: 900;
            letter-spacing: 3px; color: white;
        }

        .header-badge {
            background: rgba(255,255,255,0.15);
            padding: 5px 14px; border-radius: 20px;
            font-size: 0.75rem; font-weight: 700; color: white;
            letter-spacing: 1px;
        }

        .content { flex: 1; padding: 28px; display: none; flex-direction: column; align-items: center; overflow-y: auto; }
        .active { display: flex; }

        /* --- Gƒ∞Rƒ∞≈û EKRANI --- */
        #scr-login { justify-content: center; gap: 20px; }

        .login-title {
            font-family: 'Unbounded', sans-serif;
            font-size: 1.1rem; font-weight: 700;
            color: var(--primary); letter-spacing: 2px;
            text-align: center; margin-bottom: 10px;
        }

        .input-group { width: 100%; max-width: 380px; display: flex; flex-direction: column; gap: 12px; }

        input[type=text] {
            padding: 16px 20px;
            background: var(--card);
            border: 1.5px solid var(--border);
            border-radius: 16px;
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }
        input[type=text]:focus { border-color: var(--primary); }
        input[type=text]::placeholder { color: var(--muted); }

        .btn {
            padding: 15px 24px; border: none; border-radius: 16px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 700; font-size: 0.95rem;
            cursor: pointer; transition: all 0.2s; color: white;
            letter-spacing: 0.5px;
        }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn:active { transform: translateY(0px); }
        .btn-primary { background: var(--primary); box-shadow: 0 8px 20px var(--primary-glow); }
        .btn-secondary { background: #2563EB; }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-lg { font-size: 1.1rem; padding: 18px 32px; width: 100%; }
        .btn-row { display: flex; gap: 12px; width: 100%; max-width: 380px; }

        /* --- LOBƒ∞ --- */
        #scr-lobby { padding: 20px; }

        .room-code-badge {
            background: var(--card); border: 1.5px solid var(--border);
            border-radius: 14px; padding: 10px 22px;
            font-size: 0.85rem; color: var(--muted);
            margin-bottom: 16px; align-self: flex-start;
        }
        .room-code-badge span { font-family: 'Unbounded', sans-serif; font-weight: 700; color: var(--accent); font-size: 1rem; letter-spacing: 3px; }

        #lobby-container { display: flex; width: 100%; gap: 16px; flex: 1; min-height: 0; }

        #lobby-area {
            flex: 2;
            background: var(--card);
            border-radius: 24px;
            border: 1.5px dashed var(--border);
            position: relative;
            overflow: hidden;
            cursor: crosshair;
        }

        #lobby-area::before {
            content: "Hareket et üëÜ";
            position: absolute; bottom: 12px; right: 16px;
            font-size: 0.75rem; color: var(--muted); pointer-events: none;
        }

        .player-bubble {
            position: absolute;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary), #9333EA);
            color: white; border-radius: 40px; font-weight: 700;
            border: 3px solid rgba(255,255,255,0.2);
            white-space: nowrap;
            box-shadow: 0 8px 24px var(--primary-glow);
            transition: left 1s cubic-bezier(0.23, 1, 0.32, 1), top 1s cubic-bezier(0.23, 1, 0.32, 1);
            pointer-events: none; z-index: 5; font-size: 0.9rem;
        }
        .acc { position: absolute; font-size: 28px; left: 50%; transform: translateX(-50%); pointer-events: none; }
        .hat { top: -38px; } .gls { top: -5px; font-size: 20px; } .mus { bottom: -20px; }

        #wardrobe {
            flex: 0.8;
            background: var(--card);
            border-radius: 24px;
            padding: 16px;
            border: 1.5px solid var(--border);
            overflow-y: auto;
        }

        .wardrobe-title {
            font-size: 0.7rem; font-weight: 700; color: var(--muted);
            text-transform: uppercase; letter-spacing: 1.5px; margin: 12px 0 6px;
        }

        .acc-option {
            font-size: 20px; cursor: pointer; padding: 8px; border-radius: 10px;
            border: 1.5px solid var(--border); margin: 3px; display: inline-block;
            background: var(--surface); transition: all 0.15s;
        }
        .acc-option:hover { background: var(--accent); border-color: var(--accent); transform: scale(1.15); }

        #host-settings {
            display: none; margin-top: 14px; width: 100%;
            background: var(--card); border-radius: 20px; padding: 16px;
            border: 1.5px solid var(--border);
            flex-shrink: 0;
        }

        .settings-row { display: flex; align-items: center; gap: 14px; }
        select {
            padding: 10px 16px; border-radius: 12px;
            background: var(--surface); color: var(--text);
            border: 1.5px solid var(--border);
            font-family: 'DM Sans', sans-serif; font-size: 0.9rem;
            outline: none;
        }

        /* --- OYUN EKRANI --- */
        #scr-game { justify-content: space-between; gap: 16px; }

        .game-top { width: 100%; display: flex; justify-content: space-between; align-items: center; }

        .turn-info {
            background: var(--card); border: 1.5px solid var(--border);
            border-radius: 14px; padding: 10px 18px;
            font-size: 0.85rem; color: var(--muted);
        }
        .turn-info strong { color: var(--text); }

        #timer {
            font-family: 'Unbounded', sans-serif;
            font-size: 2.8rem; font-weight: 900; color: var(--accent);
            transition: color 0.3s;
            min-width: 80px; text-align: center;
        }
        #timer.danger { color: var(--danger); animation: timerPulse 0.5s ease-in-out infinite alternate; }
        @keyframes timerPulse { from { transform: scale(1); } to { transform: scale(1.1); } }

        /* Ses Dalgasƒ± G√∂rseli */
        .audio-visual {
            width: 100%; height: 100px;
            background: var(--card); border-radius: 20px;
            border: 1.5px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }

        canvas#waveform { width: 100%; height: 100%; }

        .audio-status {
            position: absolute;
            font-size: 0.85rem; color: var(--muted); font-weight: 500;
            pointer-events: none;
        }

        /* Kayƒ±t / Dinleme Alanƒ± */
        .action-area {
            width: 100%;
            background: var(--card);
            border-radius: 24px;
            border: 1.5px solid var(--border);
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .action-label {
            font-family: 'Unbounded', sans-serif;
            font-size: 0.85rem; letter-spacing: 2px;
            color: var(--muted); font-weight: 700;
        }

        .record-btn {
            width: 90px; height: 90px; border-radius: 50%;
            border: none; cursor: pointer;
            background: var(--danger);
            box-shadow: 0 0 0 0 rgba(239,68,68,0.4);
            transition: all 0.3s;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.2rem;
        }
        .record-btn:hover { transform: scale(1.05); }
        .record-btn.recording {
            background: #991B1B;
            animation: recordPulse 1s ease-in-out infinite;
        }
        @keyframes recordPulse {
            0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.5); }
            70% { box-shadow: 0 0 0 20px rgba(239,68,68,0); }
            100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
        }

        .record-hint { font-size: 0.8rem; color: var(--muted); text-align: center; }

        /* Efekt g√∂stergesi */
        .effect-badges {
            display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;
        }
        .effect-badge {
            background: var(--surface); border: 1.5px solid var(--border);
            border-radius: 20px; padding: 5px 14px;
            font-size: 0.75rem; font-weight: 700; color: var(--muted);
        }
        .effect-badge.active { border-color: var(--primary); color: var(--primary); background: var(--primary-glow); }

        /* Dinleme modu */
        .listen-area {
            width: 100%; display: flex; flex-direction: column; align-items: center; gap: 14px;
        }
        .listen-avatar {
            width: 70px; height: 70px; border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #9333EA);
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem;
            box-shadow: 0 0 30px var(--primary-glow);
            animation: listenPulse 1.5s ease-in-out infinite;
        }
        @keyframes listenPulse {
            0%, 100% { box-shadow: 0 0 20px var(--primary-glow); }
            50% { box-shadow: 0 0 50px var(--primary-glow); }
        }

        .who-is-playing {
            font-size: 1rem; font-weight: 700; color: var(--text); text-align: center;
        }
        .who-is-playing span { color: var(--primary); }

        /* --- Fƒ∞NAL EKRANI --- */
        #scr-final { gap: 16px; }

        #winner-text {
            font-family: 'Unbounded', sans-serif;
            font-size: 1.3rem; font-weight: 900;
            color: var(--accent); text-align: center;
        }

        .history-chain {
            width: 100%; display: flex; flex-direction: column; gap: 10px;
            overflow-y: auto; max-height: 50vh;
        }

        .history-item {
            background: var(--card); border: 1.5px solid var(--border);
            border-radius: 18px; padding: 16px 20px;
            display: flex; align-items: center; justify-content: space-between;
            gap: 12px; cursor: pointer; transition: border-color 0.2s;
        }
        .history-item:hover { border-color: var(--primary); }
        .history-item.voted { border-color: var(--accent); background: rgba(245,158,11,0.08); }

        .history-nick { font-weight: 700; font-size: 0.9rem; color: var(--primary); min-width: 80px; }
        .history-play-btn {
            background: var(--primary); border: none; border-radius: 50%;
            width: 36px; height: 36px; cursor: pointer; color: white; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
            transition: transform 0.2s;
        }
        .history-play-btn:hover { transform: scale(1.1); }
        .history-effect-info { font-size: 0.75rem; color: var(--muted); flex: 1; }
        .vote-count { font-size: 1rem; font-weight: 700; }

        /* Toast bildirimi */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--card); border: 1.5px solid var(--primary);
            border-radius: 14px; padding: 12px 24px;
            color: var(--text); font-weight: 600; z-index: 9999;
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.5s forwards;
            white-space: nowrap;
        }
        @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; pointer-events: none; } }

        /* Kƒ±rmƒ±zƒ±ya d√∂nme efekti */
        .danger-overlay {
            position: fixed; inset: 0; z-index: 0;
            background: rgba(239,68,68,0.08);
            pointer-events: none; opacity: 0;
            transition: opacity 0.5s;
        }
        .danger-overlay.show { opacity: 1; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        @media (max-width: 500px) {
            .panel { border-radius: 20px; height: 95vh; }
            .header-title { font-size: 1.1rem; }
            #timer { font-size: 2rem; }
            .record-btn { width: 75px; height: 75px; font-size: 1.8rem; }
        }
    </style>
</head>
<body>
<div class="bg-orbs">
    <div class="orb orb1"></div>
    <div class="orb orb2"></div>
    <div class="orb orb3"></div>
</div>
<div class="danger-overlay" id="danger-overlay"></div>

<div class="panel">
    <div class="header">
        <div class="header-title">Dƒ∞L-BOZ üé§</div>
        <div class="header-badge">SES Zƒ∞NCƒ∞Rƒ∞ v9</div>
    </div>

    <!-- Gƒ∞Rƒ∞≈û -->
    <div id="scr-login" class="content active">
        <div class="login-title">KAOSUN ESTETƒ∞ƒûƒ∞</div>
        <div class="input-group">
            <input type="text" id="nick" placeholder="Takma adƒ±n...">
            <div class="btn-row">
                <button class="btn btn-primary" style="flex:1" onclick="setup('host')">üè† Oda Kur</button>
                <button class="btn btn-secondary" style="flex:1" onclick="showJoinBox()">üîó Katƒ±l</button>
            </div>
            <div id="join-box" style="display:none; display:flex; flex-direction:column; gap:10px; display:none;">
                <input type="text" id="room-id" placeholder="Oda kodu (4 harf)">
                <button class="btn btn-secondary btn-lg" onclick="setup('join')">Baƒülan</button>
            </div>
        </div>
        <p style="color:var(--muted); font-size:0.8rem; margin-top:16px; text-align:center;">Mikrofon izni gereklidir</p>
    </div>

    <!-- LOBƒ∞ -->
    <div id="scr-lobby" class="content" style="padding:16px; gap:10px;">
        <div class="room-code-badge">Oda Kodu: <span id="my-id">...</span></div>
        <div id="lobby-container">
            <div id="lobby-area" onmousedown="moveMyBubble(event)" ontouchstart="moveMyBubble(event)"></div>
            <div id="wardrobe">
                <div class="wardrobe-title">≈ûapka</div>
                <div class="acc-option" onclick="setAcc('hat','üé©')">üé©</div>
                <div class="acc-option" onclick="setAcc('hat','üëë')">üëë</div>
                <div class="acc-option" onclick="setAcc('hat','üéÄ')">üéÄ</div>
                <div class="acc-option" onclick="setAcc('hat','')">‚ùå</div>
                <div class="wardrobe-title">G√∂zl√ºk</div>
                <div class="acc-option" onclick="setAcc('gls','üï∂Ô∏è')">üï∂Ô∏è</div>
                <div class="acc-option" onclick="setAcc('gls','üëì')">üëì</div>
                <div class="acc-option" onclick="setAcc('gls','ü•Ω')">ü•Ω</div>
                <div class="acc-option" onclick="setAcc('gls','')">‚ùå</div>
                <div class="wardrobe-title">Efekt</div>
                <div class="acc-option" onclick="setAcc('mus','üî•')">üî•</div>
                <div class="acc-option" onclick="setAcc('mus','‚ú®')">‚ú®</div>
                <div class="acc-option" onclick="setAcc('mus','„Ä∞Ô∏è')">„Ä∞Ô∏è</div>
                <div class="acc-option" onclick="setAcc('mus','')">‚ùå</div>
            </div>
        </div>
        <div id="host-settings">
            <div class="settings-row">
                <select id="turn-select">
                    <option value="2">2 Tur</option>
                    <option value="4">4 Tur</option>
                    <option value="6" selected>6 Tur</option>
                    <option value="8">8 Tur</option>
                </select>
                <button class="btn btn-success" style="flex:1" onclick="startGame()">üéÆ OYUNU BA≈ûLAT</button>
            </div>
        </div>
    </div>

    <!-- OYUN -->
    <div id="scr-game" class="content">
        <div class="game-top">
            <div class="turn-info">Tur <strong id="turn-num">1</strong> / <strong id="turn-max">6</strong></div>
            <div id="timer">20</div>
        </div>

        <!-- Dalga formu -->
        <div class="audio-visual">
            <canvas id="waveform"></canvas>
            <div class="audio-status" id="audio-status">Bekliyor...</div>
        </div>



        <!-- Kayƒ±t veya Dinleme alanƒ± -->
        <div class="action-area" id="action-area">
            <!-- MY TURN: Kayƒ±t -->
            <div id="my-turn-ui" style="display:none; flex-direction:column; align-items:center; gap:14px; width:100%;">
                <div class="action-label">SIRRA SEN!</div>
                <button class="record-btn" id="record-btn" onclick="toggleRecord()">üé§</button>
                <div class="record-hint" id="record-hint">Basƒ±lƒ± tut veya tƒ±kla ‚Üí Konu≈ü ‚Üí Tekrar tƒ±kla</div>
                <button class="btn btn-success" id="send-audio-btn" style="display:none" onclick="sendAudio()">üì§ G√∂nder</button>
            </div>
            <!-- WAIT: Dinleme -->
            <div id="wait-turn-ui" class="listen-area">
                <div class="action-label">≈ûU AN OYNUYOR</div>
                <div class="listen-avatar" id="listen-avatar">üé§</div>
                <div class="who-is-playing" id="who-playing">Bekliyor...</div>
            </div>
        </div>
    </div>

    <!-- Fƒ∞NAL -->
    <div id="scr-final" class="content">
        <div id="winner-text">üåÄ Oylama Zamanƒ±!</div>
        <p style="color:var(--muted); font-size:0.85rem; text-align:center;">Kayƒ±tlarƒ± dinle, en iyi bozana oy ver üî•</p>
        <div class="history-chain" id="final-results"></div>
        <div style="display:flex; gap:10px; width:100%; flex-shrink:0; margin-top:8px;">
            <button class="btn btn-danger" style="flex:1" onclick="location.reload()">üö™ Ayrƒ±l</button>
            <button class="btn btn-success" id="btn-back-lobby" style="display:none; flex:1" onclick="hostBackToLobby()">üîÑ Tekrar Oyna</button>
        </div>
    </div>
</div>

<script>
// ============================
//  GLOBALS
// ============================
let peer, connections = [], myId, myNick, players = [], turnIdx = 0, maxTurns = 6;
let history = [], votes = {}, myVoteIdx = -1;
let timerInterval, myAcc = {hat:'', gls:'', mus:''}, isHost = false;
let audioContext, mediaRecorder, recordedChunks = [], micStream;
let myTurnAudioBlob = null; // current recorded blob
let currentAudioBuffer = null; // decoded audio for waveform
let animFrame;
let effectLevel = 0; // birikimli efekt seviyesi (tur ba≈üƒ±na artar)

// ============================
//  SETUP & PEER
// ============================
function setup(mode) {
    isHost = mode === 'host';
    myNick = document.getElementById('nick').value.trim() || "Oyuncu";
    peer = new Peer(isHost ? Math.random().toString(36).substring(2,6).toUpperCase() : undefined);
    peer.on('open', id => {
        myId = id;
        document.getElementById('my-id').innerText = id;
        show('scr-lobby');
        players = [{id, nick: myNick, acc: myAcc}];
        addBubble(id, myNick, myAcc);
        if(isHost) {
            document.getElementById('host-settings').style.display = 'block';
            peer.on('connection', conn => { connections.push(conn); handleConn(conn); });
        } else {
            const conn = peer.connect(document.getElementById('room-id').value.toUpperCase());
            connections = [conn]; handleConn(conn);
        }
    });
    peer.on('error', e => toast('Baƒülantƒ± hatasƒ±: ' + e.type));
}

function showJoinBox() {
    const jb = document.getElementById('join-box');
    jb.style.display = jb.style.display === 'none' ? 'flex' : 'none';
}

function broadcast(data) { connections.forEach(c => { if(c.open) c.send(data); }); }

function handleConn(conn) {
    conn.on('open', () => {
        if(!isHost) conn.send({type:'join', nick:myNick, id:myId, acc:myAcc});
    });
    conn.on('data', d => {
        if(isHost && d.type !== 'sync' && d.type !== 'audio_submit') broadcast(d);

        if(d.type === 'join') {
            if(!players.find(p=>p.id===d.id)) { players.push({id:d.id, nick:d.nick, acc:d.acc}); addBubble(d.id, d.nick, d.acc); }
            if(isHost) broadcast({type:'list', list:players});
        }
        if(d.type === 'list') {
            d.list.forEach(p => {
                if(!players.find(x=>x.id===p.id)) { players.push(p); addBubble(p.id, p.nick, p.acc); }
                else updateBubbleAcc(p.id, p.acc);
            });
        }
        if(d.type === 'move') { let b = document.getElementById('bub-'+d.id); if(b){ b.style.left=d.x; b.style.top=d.y; }}
        if(d.type === 'acc_update') updateBubbleAcc(d.id, d.acc);

        if(d.type === 'sync') {
            turnIdx = d.turnIdx; history = d.history; maxTurns = d.maxTurns; players = d.players; effectLevel = d.effectLevel || 0;
            if(d.state === 'game') { show('scr-game'); startTurnLogic(d.lastAudio); }
            else if(d.state === 'final') showResults();
            else if(d.state === 'lobby') resetToLobby();
        }

        // Host: ses geldi, i≈üle ve herkese yayƒ±nla
        if(d.type === 'audio_submit' && isHost) {
            const processed = d.audio; // base64 blob
            history.push({nick: d.nick, audio: processed, effectLevel: d.effectLevel});
            turnIdx++;
            effectLevel = Math.min(turnIdx, 6); // birikimli efekt
            let state = (turnIdx >= maxTurns) ? 'final' : 'game';
            broadcast({type:'sync', state, turnIdx, history, players, maxTurns, lastAudio: processed, effectLevel});
            if(state === 'final') showResults(); else startTurnLogic(processed);
        }

        if(d.type === 'vote_sync') { votes = d.votes; updateVoteDisplay(); }
        if(d.type === 'typing') {
            const current = players[turnIdx % players.length];
            if(myId !== current.id) {
                document.getElementById('who-playing').innerHTML = `<span>${d.nick}</span> konu≈üuyor...`;
            }
        }
    });
}

// ============================
//  BUBBLE / LOBBƒ∞
// ============================
function addBubble(id, nick, acc) {
    if(document.getElementById('bub-'+id)) return;
    const b = document.createElement('div');
    b.id = 'bub-'+id; b.className = 'player-bubble';
    b.innerText = nick;
    b.innerHTML += `<div class="acc hat">${acc.hat||''}</div><div class="acc gls">${acc.gls||''}</div><div class="acc mus">${acc.mus||''}</div>`;
    const area = document.getElementById('lobby-area');
    b.style.left = Math.random() * (area.offsetWidth - 130) + 'px';
    b.style.top = Math.random() * (area.offsetHeight - 60) + 'px';
    area.appendChild(b);
}

function moveMyBubble(e) {
    const area = document.getElementById('lobby-area');
    const rect = area.getBoundingClientRect();
    const cx = e.clientX || (e.touches ? e.touches[0].clientX : 0);
    const cy = e.clientY || (e.touches ? e.touches[0].clientY : 0);
    const x = cx - rect.left - 50;
    const y = cy - rect.top - 25;
    const b = document.getElementById('bub-'+myId);
    if(b) {
        b.style.left = Math.max(0, Math.min(x, area.offsetWidth - 120)) + 'px';
        b.style.top = Math.max(0, Math.min(y, area.offsetHeight - 50)) + 'px';
        broadcast({type:'move', id:myId, x:b.style.left, y:b.style.top});
    }
}

function updateBubbleAcc(id, acc) {
    const b = document.getElementById('bub-'+id);
    if(b) {
        b.querySelector('.hat').innerText = acc.hat || '';
        b.querySelector('.gls').innerText = acc.gls || '';
        b.querySelector('.mus').innerText = acc.mus || '';
        let p = players.find(x=>x.id===id); if(p) p.acc = acc;
    }
}

function setAcc(type, val) {
    if(type==='hat') myAcc.hat=val; else if(type==='gls') myAcc.gls=val; else myAcc.mus=val;
    updateBubbleAcc(myId, myAcc);
    broadcast({type:'acc_update', id:myId, acc:myAcc});
}

// ============================
//  OYUN AKI≈ûI
// ============================
function startGame() {
    const mt = parseInt(document.getElementById('turn-select').value);
    const shuffled = [...players].sort(() => Math.random() - 0.5);
    broadcast({type:'sync', state:'game', turnIdx:0, history:[], players:shuffled, maxTurns:mt, lastAudio:null, effectLevel:0});
    turnIdx=0; history=[]; players=shuffled; maxTurns=mt; effectLevel=0;
    show('scr-game'); startTurnLogic(null);
}

function startTurnLogic(lastAudio) {
    clearInterval(timerInterval);
    const current = players[turnIdx % players.length];
    const isMyTurn = current.id === myId;

    document.getElementById('turn-num').innerText = turnIdx + 1;
    document.getElementById('turn-max').innerText = maxTurns;
    updateEffectBadges();
    myTurnAudioBlob = null;
    document.getElementById('send-audio-btn').style.display = 'none';
    document.getElementById('record-btn').classList.remove('recording');
    document.getElementById('record-btn').innerText = 'üé§';

    if(isMyTurn) {
        document.getElementById('my-turn-ui').style.display = 'flex';
        document.getElementById('wait-turn-ui').style.display = 'none';
        document.getElementById('audio-status').innerText = 'Senin sƒ±ran! √ñnce dinle, sonra kaydet.';

        // SADECE sƒ±radaki ki≈üi √∂nceki sesi duyar
        if(lastAudio && turnIdx > 0) {
            playAudioWithEffects(lastAudio, effectLevel, true);
        }
        startTimer();
    } else {
        document.getElementById('my-turn-ui').style.display = 'none';
        document.getElementById('wait-turn-ui').style.display = 'flex';
        document.getElementById('who-playing').innerHTML = `<span>${current.nick}</span> konu≈üuyor...`;
        document.getElementById('audio-status').innerText = current.nick + ' kaydediyor...';
        drawIdleWave();
        // Sƒ±ra sende deƒüilse ses √áALMA - sadece sƒ±radaki ki≈üi duyar
    }
}

function startTimer() {
    let t = 20;
    document.getElementById('timer').innerText = t;
    document.getElementById('timer').classList.remove('danger');
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        t--;
        document.getElementById('timer').innerText = t;
        if(t <= 5) {
            document.getElementById('timer').classList.add('danger');
            document.getElementById('danger-overlay').classList.add('show');
        }
        if(t <= 0) { clearInterval(timerInterval); sendAudio(); }
    }, 1000);
}

// ============================
//  SES KAYIT
// ============================
async function getMic() {
    if(micStream) return micStream;
    micStream = await navigator.mediaDevices.getUserMedia({audio: true});
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    return micStream;
}

let isRecording = false;

async function toggleRecord() {
    if(!isRecording) {
        await startRecording();
    } else {
        stopRecording();
    }
}

async function startRecording() {
    try {
        const stream = await getMic();
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => { if(e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = () => {
            myTurnAudioBlob = new Blob(recordedChunks, {type: 'audio/webm'});
            document.getElementById('send-audio-btn').style.display = 'block';
            document.getElementById('record-hint').innerText = 'Kaydedildi ‚úÖ ‚Äî G√∂nder veya tekrar kaydet';
            drawBlobWave(myTurnAudioBlob);
        };
        mediaRecorder.start();
        isRecording = true;
        document.getElementById('record-btn').classList.add('recording');
        document.getElementById('record-btn').innerText = '‚èπÔ∏è';
        document.getElementById('record-hint').innerText = 'Konu≈üuyor... Bitince tekrar tƒ±kla';
        drawLiveWave(stream);
        broadcast({type:'typing', nick:myNick});
    } catch(e) {
        toast('Mikrofon izni verilmedi! ‚ùå');
    }
}

function stopRecording() {
    if(mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
    }
    isRecording = false;
    cancelAnimationFrame(animFrame);
}

async function sendAudio() {
    clearInterval(timerInterval);
    document.getElementById('danger-overlay').classList.remove('show');
    document.getElementById('timer').classList.remove('danger');

    if(isRecording) stopRecording();

    // Kƒ±sa bekleme (onstop tetiklensin)
    await new Promise(r => setTimeout(r, 200));

    if(!myTurnAudioBlob) {
        // Bo≈ü ses g√∂nder
        myTurnAudioBlob = new Blob([], {type:'audio/webm'});
    }

    // Blob ‚Üí base64
    const base64 = await blobToBase64(myTurnAudioBlob);

    if(isHost) {
        history.push({nick: myNick, audio: base64, effectLevel});
        turnIdx++;
        effectLevel = Math.min(turnIdx, 6);
        let state = (turnIdx >= maxTurns) ? 'final' : 'game';
        broadcast({type:'sync', state, turnIdx, history, players, maxTurns, lastAudio: base64, effectLevel});
        if(state === 'final') showResults(); else startTurnLogic(base64);
    } else {
        connections[0].send({type:'audio_submit', audio: base64, nick: myNick, effectLevel});
    }
}

function blobToBase64(blob) {
    return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsDataURL(blob);
    });
}

// ============================
//  SES EFEKTLERƒ∞ (Web Audio)
// ============================
/*
  effectLevel 0 ‚Üí temiz
  effectLevel 1 ‚Üí hafif perde kaymasƒ±
  effectLevel 2 ‚Üí hƒ±z deƒüi≈üimi
  effectLevel 3 ‚Üí reverb
  effectLevel 4 ‚Üí robot (ring modulation)
  effectLevel 5+ ‚Üí hepsi birden, kaotik
*/
async function playAudioWithEffects(base64, level, isPreview) {
    if(!base64 || base64.length < 100) return;
    if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    if(audioContext.state === 'suspended') await audioContext.resume();

    const resp = await fetch(base64);
    const arrayBuf = await resp.arrayBuffer();
    let decoded;
    try { decoded = await audioContext.decodeAudioData(arrayBuf); }
    catch(e) { return; }

    drawDecodedWave(decoded);

    const source = audioContext.createBufferSource();
    source.buffer = decoded;

    // Perde: 200 yerine 360 cent ‚Äî daha belirgin ince/kalƒ±n
    // tur 1‚Üí +360 (ince), tur 2‚Üí -360 (kalƒ±n), tur 3‚Üí +720 (√ßok ince), tur 4‚Üí -720 (√ßok kalƒ±n)...
    const direction = (level % 2 === 0) ? 1 : -1;
    const amount = Math.ceil(level / 2) * 360;
    source.detune.value = direction * amount;

    // Hƒ±z: her turda biraz hƒ±zlanƒ±r veya yava≈ülar
    // level 0‚Üínormal, 1‚Üíhƒ±zlƒ±, 2‚Üíyava≈ü, 3‚Üídaha hƒ±zlƒ±, 4‚Üídaha yava≈ü...
    const speedMap = [1, 1.35, 0.70, 1.55, 0.60, 1.70, 0.55];
    source.playbackRate.value = speedMap[Math.min(level, speedMap.length - 1)];

    // Ses seviyesi sabit
    const gainNode = audioContext.createGain();
    gainNode.gain.value = 0.9;
    source.connect(gainNode);
    gainNode.connect(audioContext.destination);
    source.start();

    document.getElementById('audio-status').innerText = isPreview ? 'üéß √ñnceki tur sesi √ßalƒ±yor...' : 'üîä √áalƒ±yor...';
}





function updateEffectBadges() { /* kaldƒ±rƒ±ldƒ± */ }

// ============================
//  DALGA √áƒ∞Zƒ∞Mƒ∞
// ============================
function getCanvas() {
    const c = document.getElementById('waveform');
    c.width = c.offsetWidth; c.height = c.offsetHeight;
    return c;
}

function drawIdleWave() {
    cancelAnimationFrame(animFrame);
    const c = getCanvas(); const ctx = c.getContext('2d');
    let t = 0;
    function frame() {
        ctx.clearRect(0, 0, c.width, c.height);
        ctx.beginPath();
        ctx.strokeStyle = '#2A2A40'; ctx.lineWidth = 2;
        for(let x = 0; x < c.width; x++) {
            const y = c.height/2 + Math.sin((x/c.width)*4*Math.PI + t) * 8;
            x === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
        }
        ctx.stroke();
        t += 0.03;
        animFrame = requestAnimationFrame(frame);
    }
    frame();
    document.getElementById('audio-status').innerText = '';
}

function drawLiveWave(stream) {
    cancelAnimationFrame(animFrame);
    if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const analyser = audioContext.createAnalyser();
    analyser.fftSize = 256;
    const src = audioContext.createMediaStreamSource(stream);
    src.connect(analyser);
    const data = new Uint8Array(analyser.frequencyBinCount);
    const c = getCanvas(); const ctx = c.getContext('2d');
    function frame() {
        analyser.getByteTimeDomainData(data);
        ctx.clearRect(0, 0, c.width, c.height);
        ctx.beginPath(); ctx.strokeStyle = '#EF4444'; ctx.lineWidth = 2.5;
        data.forEach((v, i) => {
            const x = (i / data.length) * c.width;
            const y = (v / 128.0) * c.height / 2;
            i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
        });
        ctx.stroke();
        animFrame = requestAnimationFrame(frame);
    }
    frame();
}

async function drawBlobWave(blob) {
    cancelAnimationFrame(animFrame);
    if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    try {
        const ab = await blob.arrayBuffer();
        const decoded = await audioContext.decodeAudioData(ab);
        drawDecodedWave(decoded);
    } catch(e) {}
}

function drawDecodedWave(decoded) {
    cancelAnimationFrame(animFrame);
    const c = getCanvas(); const ctx = c.getContext('2d');
    const data = decoded.getChannelData(0);
    const step = Math.ceil(data.length / c.width);
    ctx.clearRect(0, 0, c.width, c.height);
    ctx.beginPath(); ctx.strokeStyle = '#7C3AED'; ctx.lineWidth = 1.5;
    for(let i = 0; i < c.width; i++) {
        const val = data[i * step] || 0;
        const y = (1 + val) * c.height / 2;
        i === 0 ? ctx.moveTo(i, y) : ctx.lineTo(i, y);
    }
    ctx.stroke();
}

// ============================
//  SONU√á & OYLAMA
// ============================
function showResults() {
    show('scr-final');
    updateVoteDisplay();
    if(isHost) document.getElementById('btn-back-lobby').style.display = 'block';
}

function updateVoteDisplay() {
    const resDiv = document.getElementById('final-results');
    let maxV = 0, winner = '';
    resDiv.innerHTML = history.map((h, i) => {
        const v = votes[i] || 0;
        if(v > maxV) { maxV = v; winner = h.nick; }
        const effLvl = h.effectLevel || 0;
        const fxLabels = ['Temiz','üéµ Perde','‚è© Hƒ±zlƒ±','üåä Reverb','ü§ñ Robot','üí• Kaos','üåÄ Mega Kaos'];
        const fxLabel = fxLabels[Math.min(effLvl, fxLabels.length-1)];
        const isVoted = myVoteIdx === i;
        return `<div class="history-item${isVoted ? ' voted' : ''}" onclick="castVote(${i})">
            <div class="history-nick">${h.nick}</div>
            <div class="history-effect-info">${fxLabel}</div>
            <button class="history-play-btn" onclick="event.stopPropagation(); playHistoryAudio(${i})">‚ñ∂</button>
            <div class="vote-count">üî• ${v}</div>
        </div>`;
    }).join('');
    if(maxV > 0) document.getElementById('winner-text').innerText = 'üëë KRAL: ' + winner;
}

function playHistoryAudio(idx) {
    const h = history[idx];
    if(h && h.audio) playAudioWithEffects(h.audio, h.effectLevel || 0, false);
    else toast('Bu oyuncu ses g√∂ndermedi ü§´');
}

function castVote(idx) {
    if(myVoteIdx === idx) { votes[idx] = Math.max(0, (votes[idx]||0)-1); myVoteIdx = -1; }
    else { if(myVoteIdx !== -1) votes[myVoteIdx] = Math.max(0, (votes[myVoteIdx]||0)-1); votes[idx] = (votes[idx]||0) + 1; myVoteIdx = idx; }
    broadcast({type:'vote_sync', votes}); updateVoteDisplay();
}

function hostBackToLobby() {
    broadcast({type:'sync', state:'lobby', turnIdx:0, history:[], players, maxTurns, lastAudio:null, effectLevel:0});
    resetToLobby();
}

function resetToLobby() {
    clearInterval(timerInterval); cancelAnimationFrame(animFrame);
    turnIdx=0; history=[]; votes={}; myVoteIdx=-1; effectLevel=0;
    myTurnAudioBlob=null;
    document.getElementById('danger-overlay').classList.remove('show');
    document.getElementById('timer').classList.remove('danger');
    show('scr-lobby');
}

// ============================
//  YARDIMCI
// ============================
function show(id) {
    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function toast(msg) {
    const existing = document.querySelector('.toast');
    if(existing) existing.remove();
    const t = document.createElement('div');
    t.className = 'toast'; t.innerText = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

// ƒ∞lk idle wave
window.addEventListener('load', () => {
    // canvas boyutlandƒ±rma i√ßin kƒ±sa gecikme
    setTimeout(drawIdleWave, 500);
});
</script>
</body>
</html>